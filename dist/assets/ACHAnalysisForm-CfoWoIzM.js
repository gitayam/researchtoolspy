import{j as e}from"./ui-vendor-DBphXmDA.js";import{r as h}from"./react-vendor-CfYLSWvh.js";import{B as u,e as y,l as G,m as M,n as Q,o as X,I as A,t as k,y as S,q as R,S as V,z as J,C as U,E as D,F as E}from"./index-DGGXJgUa.js";import{C as F,a as q,b as L,d as z,c as ee}from"./card-BQo7RV_Z.js";import{E as K}from"./EvidenceItemForm-DLuun9hp.js";import{W as Y,a as se,d as te,aj as O,$ as ae,q as Z,E as re,S as W,C as $,V as ie,an as ne}from"./icons-x9tcvtYN.js";function le({analysisId:j,selectedEvidence:l,onEvidenceChange:f}){const[d,p]=h.useState([]),[i,g]=h.useState(""),[a,c]=h.useState(!1),[v,N]=h.useState(!1),[m,w]=h.useState(null),[C,b]=h.useState(!1);h.useEffect(()=>{t()},[]);const t=async()=>{try{b(!0);const r=await fetch("/api/evidence-items");if(r.ok){const n=await r.json();p(n.evidence||[])}}catch(r){console.error("Failed to load evidence:",r)}finally{b(!1)}},s=async r=>{try{const n=await fetch("/api/evidence-items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!n.ok)throw new Error("Failed to create evidence");const I=await n.json();await t(),f([...l,String(I.id)]),N(!1)}catch(n){throw console.error("Error creating evidence:",n),n}},o=async r=>{if(m)try{if(!(await fetch(`/api/evidence-items?id=${m.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).ok)throw new Error("Failed to update evidence");await t(),w(null)}catch(n){throw console.error("Error updating evidence:",n),n}},x=r=>{l.includes(r)?f(l.filter(n=>n!==r)):f([...l,r])},_=r=>{f(l.filter(n=>n!==r))},H=()=>d.filter(r=>l.includes(String(r.id))),T=d.filter(r=>i===""||r.title.toLowerCase().includes(i.toLowerCase())||r.description?.toLowerCase().includes(i.toLowerCase())||r.tags.some(I=>I.toLowerCase().includes(i.toLowerCase()))),P=H();return e.jsxs(F,{children:[e.jsx(q,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(L,{children:"Evidence"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:"Link evidence from your library or create new evidence items"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{type:"button",variant:"outline",size:"sm",onClick:()=>N(!0),children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Create New"]}),e.jsxs(u,{type:"button",variant:"outline",size:"sm",onClick:()=>c(!0),children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Browse Library"]})]})]})}),e.jsx(z,{children:P.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400 border-2 border-dashed rounded-lg",children:[e.jsx(te,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"font-medium",children:"No evidence linked yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Add evidence from your library or create new items"})]}):e.jsx("div",{className:"space-y-2",children:P.map(r=>e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsx(O,{className:"h-5 w-5 text-green-600 dark:text-green-400 mt-0.5 flex-shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-sm",children:r.title}),r.description&&e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mt-1 line-clamp-2",children:r.description}),e.jsxs("div",{className:"flex flex-wrap gap-1 mt-2",children:[e.jsx(y,{variant:"outline",className:"text-xs",children:r.evidence_type.replace("_"," ")}),e.jsx(y,{variant:"outline",className:"text-xs",children:r.confidence_level}),r.tags.slice(0,3).map(n=>e.jsx(y,{variant:"secondary",className:"text-xs",children:n},n))]})]}),e.jsxs("div",{className:"flex gap-1 flex-shrink-0",children:[e.jsx(u,{type:"button",variant:"ghost",size:"icon",className:"text-blue-600 hover:text-blue-700",onClick:()=>w(r),title:"Edit evidence",children:e.jsx(ae,{className:"h-4 w-4"})}),e.jsx(u,{type:"button",variant:"ghost",size:"icon",className:"text-red-600 hover:text-red-700",onClick:()=>_(String(r.id)),title:"Remove from analysis",children:e.jsx(Z,{className:"h-4 w-4"})})]})]})})]},r.id))})}),e.jsx(G,{open:a,onOpenChange:c,children:e.jsxs(M,{className:"max-w-4xl max-h-[80vh] overflow-hidden flex flex-col",children:[e.jsx(Q,{children:e.jsx(X,{children:"Select Evidence from Library"})}),e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col",children:[e.jsx("div",{className:"mb-4",children:e.jsx(A,{placeholder:"Search evidence by title, description, or tags...",value:i,onChange:r=>g(r.target.value),className:"w-full"})}),e.jsx("div",{className:"flex-1 overflow-y-auto pr-2 space-y-2",children:C?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading evidence..."}):T.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:i?"No evidence found matching your search":"No evidence in library yet"}):T.map(r=>{const n=l.includes(String(r.id));return e.jsx("div",{onClick:()=>x(String(r.id)),className:k("p-3 rounded-lg border-2 cursor-pointer transition-colors",n?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:k("h-5 w-5 rounded border-2 flex items-center justify-center flex-shrink-0 mt-0.5",n?"border-blue-500 bg-blue-500":"border-gray-300 dark:border-gray-600"),children:n&&e.jsx(O,{className:"h-4 w-4 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-sm",children:r.title}),r.description&&e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mt-1 line-clamp-2",children:r.description}),e.jsxs("div",{className:"flex flex-wrap gap-1 mt-2",children:[e.jsx(y,{variant:"outline",className:"text-xs",children:r.evidence_type.replace("_"," ")}),e.jsxs(y,{variant:"outline",className:"text-xs",children:["Credibility: ",r.credibility]}),e.jsx(y,{variant:"outline",className:"text-xs",children:r.confidence_level}),r.source_url&&e.jsxs(y,{variant:"outline",className:"text-xs",children:[e.jsx(re,{className:"h-3 w-3 mr-1"}),"Source"]})]})]})]})},r.id)})}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t mt-4",children:[e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:[l.length," evidence item",l.length!==1?"s":""," selected"]}),e.jsx(u,{onClick:()=>c(!1),children:"Done"})]})]})]})}),v&&e.jsx(K,{open:v,onClose:()=>N(!1),onSave:s,mode:"create"}),m&&e.jsx(K,{open:!!m,onClose:()=>w(null),onSave:o,initialData:m,mode:"edit"})]})}function B({className:j,...l}){return e.jsx("div",{className:k("animate-pulse rounded-md bg-gray-200 dark:bg-gray-800",j),...l})}function oe({frameworkType:j,context:l,onSelectEvidence:f,selectedEvidenceIds:d=[],className:p}){const[i,g]=h.useState([]),[a,c]=h.useState(!0),[v,N]=h.useState(null),[m,w]=h.useState(null);h.useEffect(()=>{C()},[j,JSON.stringify(l)]);const C=async()=>{c(!0),N(null);try{const s=localStorage.getItem("omnicore_user_hash"),o=await fetch("/api/evidence/recommend",{method:"POST",headers:{"Content-Type":"application/json",...s&&{Authorization:`Bearer ${s}`}},body:JSON.stringify({framework_type:j,context:l,workspace_id:"1"})});if(!o.ok)throw new Error("Failed to load evidence recommendations");const x=await o.json();g(x.recommendations||[]),w(x.breakdown||{})}catch(s){console.error("Error loading evidence recommendations:",s),N(s instanceof Error?s.message:"Unknown error")}finally{c(!1)}},b=s=>s>=70?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":s>=40?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200":"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200",t=s=>{const o=s?.toUpperCase().charAt(0);return["A","B"].includes(o)||s==="verified"?e.jsx(O,{className:"h-3 w-3 text-green-600"}):["C","D"].includes(o)?e.jsx($,{className:"h-3 w-3 text-yellow-600"}):null};return a?e.jsxs(F,{className:p,children:[e.jsx(q,{children:e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5"}),"Loading Recommendations..."]})}),e.jsxs(z,{className:"space-y-3",children:[e.jsx(B,{className:"h-20 w-full"}),e.jsx(B,{className:"h-20 w-full"}),e.jsx(B,{className:"h-20 w-full"})]})]}):v?e.jsx(F,{className:k("border-destructive",p),children:e.jsx(z,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-2 text-destructive",children:[e.jsx($,{className:"h-5 w-5"}),e.jsxs("p",{children:["Failed to load recommendations: ",v]})]})})}):i.length===0?null:e.jsxs(F,{className:p,children:[e.jsxs(q,{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5 text-primary"}),"Suggested Evidence (",i.length,")"]}),e.jsxs(ee,{children:["Based on ",l.entities?.length?"entities, ":"",l.keywords?.length?"keywords, ":"","and similar analyses"]}),m&&e.jsxs("div",{className:"flex gap-3 text-sm text-muted-foreground mt-2",children:[m.high_relevance>0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{className:"h-3 w-3"}),m.high_relevance," high relevance"]}),m.entity_matches>0&&e.jsxs("div",{children:[m.entity_matches," entity matches"]}),m.keyword_matches>0&&e.jsxs("div",{children:[m.keyword_matches," keyword matches"]})]})]}),e.jsxs(z,{className:"space-y-3",children:[i.map(s=>{const o=d.includes(s.id);return e.jsxs("div",{className:k("flex items-start justify-between p-4 border rounded-lg transition-all",o&&"border-primary bg-primary/5",!o&&"hover:border-primary/50 hover:shadow-sm"),children:[e.jsxs("div",{className:"flex-1 min-w-0 pr-4",children:[e.jsxs("div",{className:"flex items-start gap-2 mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-sm line-clamp-1",children:s.title}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2 mt-1",children:s.description})]}),e.jsxs(y,{className:k("shrink-0",b(s.relevance_score)),children:[s.relevance_score,"%"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.evidence_level&&e.jsx(y,{variant:"outline",className:"text-xs",children:s.evidence_level}),s.credibility&&e.jsxs(y,{variant:"secondary",className:"text-xs flex items-center gap-1",children:[t(s.credibility),s.credibility]}),s.priority&&e.jsx(y,{variant:s.priority==="critical"||s.priority==="high"?"destructive":"outline",className:"text-xs",children:s.priority})]}),s.match_reasons.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-1",children:[s.match_reasons.slice(0,3).map((x,_)=>e.jsx("span",{className:"text-xs text-muted-foreground bg-muted px-2 py-0.5 rounded",children:x},_)),s.match_reasons.length>3&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",s.match_reasons.length-3," more"]})]})]}),e.jsx(u,{size:"sm",variant:o?"secondary":"default",onClick:()=>f(s),disabled:o,className:"shrink-0",children:o?"Added":"Add"})]},s.id)}),i.length>=20&&e.jsx("div",{className:"text-center pt-2",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Showing top 20 recommendations. Refine your search for more specific results."})})]})]})}function ge({open:j,onClose:l,onSave:f,initialData:d,mode:p}){const[i,g]=h.useState(!1),[a,c]=h.useState({title:"",description:"",question:"",analyst:"",organization:"",scale_type:"logarithmic",status:"draft",hypotheses:[],evidence_ids:[]}),[v,N]=h.useState("");h.useEffect(()=>{c(d?{title:d.title,description:d.description||"",question:d.question,analyst:d.analyst||"",organization:d.organization||"",scale_type:d.scale_type,status:d.status,hypotheses:d.hypotheses?.map(t=>({id:t.id,text:t.text,rationale:t.rationale,source:t.source,order_num:t.order_num}))||[],evidence_ids:d.evidence?.map(t=>t.evidence_id)||[]}:{title:"",description:"",question:"",analyst:"",organization:"",scale_type:"logarithmic",status:"draft",hypotheses:[],evidence_ids:[]})},[d,j]);const m=async t=>{if(t.preventDefault(),!a.title.trim()||!a.question.trim()){alert("Title and question are required");return}if(a.hypotheses.length<2){alert("Please add at least 2 hypotheses for analysis");return}g(!0);try{await f(a),l()}catch(s){console.error("Failed to save analysis:",s),alert("Failed to save analysis. Please try again.")}finally{g(!1)}},w=()=>{v.trim()&&(c({...a,hypotheses:[...a.hypotheses,{text:v,order_num:a.hypotheses.length}]}),N(""))},C=t=>{c({...a,hypotheses:a.hypotheses.filter((s,o)=>o!==t).map((s,o)=>({...s,order_num:o}))})},b=(t,s)=>{const o=s==="up"?t-1:t+1;if(o<0||o>=a.hypotheses.length)return;const x=[...a.hypotheses],_=x[t];x[t]=x[o],x[o]=_,x.forEach((H,T)=>{H.order_num=T}),c({...a,hypotheses:x})};return e.jsx(G,{open:j,onOpenChange:l,children:e.jsxs(M,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Q,{children:e.jsx(X,{children:p==="create"?"Create ACH Analysis":"Edit ACH Analysis"})}),e.jsxs("form",{onSubmit:m,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(S,{htmlFor:"title",children:"Analysis Title *"}),e.jsx(A,{id:"title",value:a.title,onChange:t=>c({...a,title:t.target.value}),placeholder:"e.g., Who was responsible for the cyber attack?",required:!0})]}),e.jsxs("div",{children:[e.jsx(S,{htmlFor:"question",children:"Key Question *"}),e.jsx(R,{id:"question",value:a.question,onChange:t=>c({...a,question:t.target.value}),placeholder:"The primary intelligence question this analysis seeks to answer",rows:2,required:!0})]}),e.jsxs("div",{children:[e.jsx(S,{htmlFor:"description",children:"Description"}),e.jsx(R,{id:"description",value:a.description,onChange:t=>c({...a,description:t.target.value}),placeholder:"Additional context or background for this analysis",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(S,{htmlFor:"analyst",children:"Analyst"}),e.jsx(A,{id:"analyst",value:a.analyst,onChange:t=>c({...a,analyst:t.target.value}),placeholder:"Lead analyst name"})]}),e.jsxs("div",{children:[e.jsx(S,{htmlFor:"organization",children:"Organization"}),e.jsx(A,{id:"organization",value:a.organization,onChange:t=>c({...a,organization:t.target.value}),placeholder:"Agency or organization"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(S,{htmlFor:"scale_type",children:"Scoring Scale"}),e.jsxs(V,{value:a.scale_type,onValueChange:t=>c({...a,scale_type:t}),children:[e.jsx(J,{id:"scale_type",children:e.jsx(U,{})}),e.jsxs(D,{children:[e.jsx(E,{value:"logarithmic",children:"Logarithmic (Fibonacci: 1,3,5,8,13)"}),e.jsx(E,{value:"linear",children:"Linear (1-5)"})]})]})]}),e.jsxs("div",{children:[e.jsx(S,{htmlFor:"status",children:"Status"}),e.jsxs(V,{value:a.status,onValueChange:t=>c({...a,status:t}),children:[e.jsx(J,{id:"status",children:e.jsx(U,{})}),e.jsxs(D,{children:[e.jsx(E,{value:"draft",children:"Draft"}),e.jsx(E,{value:"in_progress",children:"In Progress"}),e.jsx(E,{value:"completed",children:"Completed"})]})]})]})]})]}),e.jsxs(F,{children:[e.jsxs(q,{children:[e.jsx(L,{children:"Competing Hypotheses"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Add at least 2 hypotheses to analyze (minimum recommended: 3-5)"})]}),e.jsxs(z,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{value:v,onChange:t=>N(t.target.value),placeholder:"Enter a hypothesis...",onKeyPress:t=>{t.key==="Enter"&&(t.preventDefault(),w())}}),e.jsxs(u,{type:"button",onClick:w,children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Add"]})]}),e.jsx("div",{className:"space-y-2",children:a.hypotheses.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:"No hypotheses added yet. Add at least 2 to begin analysis."}):a.hypotheses.map((t,s)=>e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(u,{type:"button",variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onClick:()=>b(s,"up"),disabled:s===0,children:"▲"}),e.jsx(u,{type:"button",variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onClick:()=>b(s,"down"),disabled:s===a.hypotheses.length-1,children:"▼"})]}),e.jsx(ne,{className:"h-4 w-4 text-gray-400"}),e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsxs("span",{className:"font-medium text-sm",children:["H",s+1,":"]}),e.jsx("p",{className:"text-sm flex-1",children:t.text})]})}),e.jsx(u,{type:"button",variant:"ghost",size:"icon",onClick:()=>C(s),className:"text-red-600 hover:text-red-700",children:e.jsx(Z,{className:"h-4 w-4"})})]},s))})]})]}),p==="create"&&a.title&&e.jsx(oe,{frameworkType:"ach",context:{title:a.title,description:a.description,keywords:ce(a.title,a.question,a.description)},onSelectEvidence:t=>{a.evidence_ids?.includes(String(t.id))||c({...a,evidence_ids:[...a.evidence_ids||[],String(t.id)]})},selectedEvidenceIds:(a.evidence_ids||[]).map(t=>parseInt(t))}),e.jsx(le,{analysisId:d?.id,selectedEvidence:a.evidence_ids||[],onEvidenceChange:t=>c({...a,evidence_ids:t})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(u,{type:"button",variant:"outline",onClick:l,disabled:i,children:"Cancel"}),e.jsx(u,{type:"submit",disabled:i,children:i?"Saving...":p==="create"?"Create Analysis":"Save Changes"})]})]})]})})}function ce(...j){const l=j.filter(Boolean).join(" "),f=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","was","are","were","been","be","have","has","had","do","does","did","will","would","could","should","may","might","must","can","this","that","these","those"]),p=l.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(i=>i.length>3&&!f.has(i)).reduce((i,g)=>(i[g]=(i[g]||0)+1,i),{});return Object.entries(p).sort((i,g)=>g[1]-i[1]).slice(0,10).map(([i])=>i)}export{ge as A};
